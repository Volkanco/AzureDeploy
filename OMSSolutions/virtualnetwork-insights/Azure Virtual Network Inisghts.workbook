{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "e842b99d-8cc3-4422-8d33-f9f8cbc173b8",
            "version": "KqlParameterItem/1.0",
            "name": "location",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| project id,name, resourceGroup,subscriptionId,location,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| distinct  location",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "6d390ba8-fce9-4566-9049-c188ee78547c",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": true,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "0f5221cc-39cd-483e-a877-b31bbd28a728",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Summary",
            "subTarget": "tab1",
            "preText": "Summary",
            "style": "link"
          },
          {
            "id": "04f172ec-3cf8-4b8c-9040-3f83bb968d93",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Internet Egress ",
            "subTarget": "tab6",
            "style": "link"
          },
          {
            "id": "8554e947-bf12-4a11-9e30-e279ccecc1cc",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "NSG",
            "subTarget": "tab3",
            "preText": "NSG",
            "style": "link"
          },
          {
            "id": "c91fdf55-5015-41a7-970f-60aceee1705b",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "DDOS",
            "subTarget": "tab4",
            "style": "link"
          },
          {
            "id": "56e61b22-0d17-44d7-b887-3b404f46cc25",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Peerings",
            "subTarget": "tab5",
            "style": "link"
          }
        ]
      },
      "name": "links - 9"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| summarize Vnets=count(id) by location",
        "size": 4,
        "title": "VNET Locations",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "tiles",
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "location",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Vnets",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "name": "query - 0"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand subnet = properties.subnets\r\n| extend subnetName = tostring(subnet.name)\r\n| extend subnetCidr = tostring(subnet.properties.addressPrefix)\r\n| extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n| extend natGatewayId = tostring(subnet.properties.natGateway.id)\r\n| extend routeTableId = tostring(subnet.properties.routeTable.id)\r\n| extend isPrivate = case(\r\n    defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\", true,\r\n    false\r\n  )\r\n| extend hasNatGateway = isnotempty(natGatewayId)\r\n| extend natGatewayName = iff(hasNatGateway, extract(@\"natGateways/(.+)$\", 1, natGatewayId), \"None\")\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.network/routetables\"\r\n    | mv-expand route = properties.routes\r\n    | where tostring(route.properties.addressPrefix) == \"0.0.0.0/0\"\r\n    | project routeTableId = id,\r\n        routeTableName = name,\r\n        nextHopType = tostring(route.properties.nextHopType),\r\n        nextHopIp = tostring(route.properties.nextHopIpAddress)\r\n) on routeTableId\r\n| extend hasInternetUDR = isnotempty(nextHopType)\r\n| extend internetRoute = case(\r\n    isnotempty(nextHopIp), strcat(nextHopType, \" -> \", nextHopIp),\r\n    isnotempty(nextHopType), nextHopType,\r\n    \"None\"\r\n  )\r\n| extend OutboundStatus = case(\r\n    isPrivate and hasNatGateway, \"âœ… Private Subnet + NAT Gateway\",\r\n    isPrivate and hasInternetUDR and nextHopType == \"VirtualAppliance\", \"âœ… Private Subnet + Firewall\",\r\n    isPrivate and hasInternetUDR and nextHopType == \"Internet\", \"âš ï¸ Private Subnet + Direct Internet UDR\",\r\n    isPrivate and not(hasNatGateway) and not(hasInternetUDR), \"ðŸ”’ Private Subnet - No Outbound Path\",\r\n    not(isPrivate) and hasNatGateway, \"NAT Gateway (Not Private)\",\r\n    not(isPrivate) and hasInternetUDR, \"UDR Egress (Not Private)\",\r\n    not(isPrivate), \"Default Azure Egress (Not Private)\",\r\n    \"Unknown\"\r\n  )\r\n| project VNetName = name, SubnetName = subnetName, SubnetCIDR = subnetCidr,\r\n    IsPrivate = isPrivate, NATGateway = natGatewayName,\r\n    InternetUDR = internetRoute, OutboundStatus,\r\n    subscriptionId\r\n| order by IsPrivate desc, OutboundStatus asc\r\n|summarize VNEts=count(VNetName), SubnetCount=count(SubnetName) by OutboundStatus",
        "size": 1,
        "title": "All Internet Routes",
        "exportFieldName": "InternetEgress",
        "exportParameterName": "InternetEgress",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "customWidth": "33",
      "name": "query - 2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id,name, resourceGroup,subscriptionId,location,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| summarize Count=count(id) by DDOS_Enabled=tostring(ddos)",
        "size": 1,
        "title": "DDOS Enabled VNETs",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "true",
              "color": "green"
            },
            {
              "seriesName": "false",
              "color": "orangeDark"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "customWidth": "33",
      "name": "query - 2 - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "\r\nresources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id,name, resourceGroup,subscriptionId,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| mv-expand (subnets)\r\n| extend subnetcidr=subnets.properties.addressPrefix, UDRid=tostring(subnets.properties.routeTable.id),subnetname=subnets.name, dellist=todynamic(subnets.properties.delegations), servicelinks=todynamic(subnets.properties.serviceAssociationLinks)\r\n| extend delagation=tostring(dellist[0].name)\r\n| extend linkedservice= servicelinks[0].properties.linkedResourceType\r\n| extend delagation=tostring(iff(isempty( linkedservice),delagation,linkedservice))\r\n| summarize Count=count() by delagation\r\n| extend DelegatedService=iff(isempty( delagation),\"NoDelagation\",delagation)\r\n| project DelegatedService,Count\r\n",
        "size": 1,
        "title": "Subnet Delagations / Linked Services",
        "exportFieldName": "InternetEgress",
        "exportParameterName": "InternetEgress",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "customWidth": "33",
      "name": "query - 2 - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id,name, resourceGroup,subscriptionId,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| mv-expand (subnets)\r\n| extend subnetcidr=subnets.properties.addressPrefix, UDRid=tostring(subnets.properties.routeTable.id),subnetname=subnets.name, dellist=todynamic(subnets.properties.delegations), servicelinks=todynamic(subnets.properties.serviceAssociationLinks)\r\n| extend delagation=tostring(dellist[0].name)\r\n| extend linkedservice= servicelinks[0].properties.linkedResourceType\r\n| extend delagation=tostring(iff(isempty( linkedservice),delagation,linkedservice))\r\n| join kind=leftouter \r\n(\r\nresources\r\n| where type == \"microsoft.network/routetables\"\r\n| extend routes=properties.routes,hasDefaultRoute=iff(properties.routes contains \"0.0.0.0/0\",true,false)\r\n| project id, name, routes,hasDefaultRoute\r\n| mv-expand (routes)\r\n| extend  addressPrefix=routes.properties.addressPrefix, nextHopIpAddress=routes.properties.nextHopIpAddress,nextHopType=routes.properties.nextHopType) on $left.UDRid==$right.id\r\n| project VNETName=name, subscriptionId,subnetname,subnetcidr,UDR=name1,addressPrefix,nextHopType,nextHopIpAddress,hasDefaultRoute, delagation\r\n",
        "size": 0,
        "title": "Assigned Routes for VNEts/Subnets - Delagations",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "name": "query - 2 - Copy"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "52fb0b7a-2065-45ab-a37e-68ee8b3f6a95",
            "version": "KqlParameterItem/1.0",
            "name": "EgressType",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "\r\nresources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| project id,name, resourceGroup,subscriptionId,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| mv-expand (subnets)\r\n| extend subnetcidr=subnets.properties.addressPrefix, UDRid=tostring(subnets.properties.routeTable.id),subnetname=subnets.name\r\n| join kind=leftouter \r\n(\r\nresources\r\n| where type == \"microsoft.network/routetables\"\r\n| extend routes=properties.routes,hasDefaultRoute=iff(properties.routes contains \"0.0.0.0/0\",true,false)\r\n| project id, name,subscriptionId, routes,hasDefaultRoute\r\n| mv-expand (routes)\r\n| extend  addressPrefix=routes.properties.addressPrefix, nextHopIpAddress=routes.properties.nextHopIpAddress,nextHopType=routes.properties.nextHopType\r\n| where hasDefaultRoute == true\r\n| extend CheckDefRoute=iff(addressPrefix startswith  \"0.0.0.0\" , strcat(addressPrefix,\" |\",nextHopType,\" |\",nextHopIpAddress),\"\")\r\n|summarize CheckDefRoute=make_set(CheckDefRoute) by id, name ,subscriptionId) on $left.UDRid==$right.id\r\n| project VNETName=name, subscriptionId,subnetname,subnetcidr,UDR=iff(isnotempty(name1),name1,\"No UDR Defined\"),CheckDefRoute= iff(isnotempty(name1),strcat_array(CheckDefRoute,''),\"DefaultAzureEgressNoUDR\")\r\n|summarize SubnetCount=count(subnetname) by CheckDefRoute\r\n| extend InternetEgress=case(CheckDefRoute ==\"0.0.0.0/0 |Internet |\",\"DirectEgresstoInternetviaUDR\",\r\nCheckDefRoute contains \"VirtualAppliance\" , \"Internet Sent to Firewall\",\r\nCheckDefRoute ==\"DefaultAzureEgressNoUDR\", \"Azure Default Internet \",\"Unkown\")\r\n| distinct InternetEgress",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab2"
      },
      "name": "parameters - 17"
    },
    {
      "type": 1,
      "content": {
        "json": ""
      },
      "name": "text - 16"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid}) \r\n| project id,name, resourceGroup,subscriptionId,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| mv-expand (subnets)\r\n| extend subnetcidr=subnets.properties.addressPrefix, UDRid=tostring(subnets.properties.routeTable.id),subnetname=subnets.name\r\n| join kind=leftouter \r\n(\r\nresources\r\n| where type == \"microsoft.network/routetables\"\r\n| extend routes=properties.routes,hasDefaultRoute=iff(properties.routes contains \"0.0.0.0/0\",true,false)\r\n| project id, name,subscriptionId, routes,hasDefaultRoute\r\n| mv-expand (routes)\r\n| extend  addressPrefix=routes.properties.addressPrefix, nextHopIpAddress=routes.properties.nextHopIpAddress,nextHopType=routes.properties.nextHopType\r\n| where hasDefaultRoute == true\r\n| extend CheckDefRoute=iff(addressPrefix startswith  \"0.0.0.0\" , strcat(addressPrefix,\" |\",nextHopType,\" |\",nextHopIpAddress),\"\")\r\n|summarize CheckDefRoute=make_set(CheckDefRoute) by id, name ,subscriptionId) on $left.UDRid==$right.id\r\n| project VNETName=name, subscriptionId,subnetname,subnetcidr,UDR=iff(isnotempty(name1),name1,\"No UDR Defined\"),CheckDefRoute= iff(isnotempty(name1),strcat_array(CheckDefRoute,''),\"DefaultAzureEgressNoUDR\")\r\n| extend InternetEgress=case(CheckDefRoute ==\"0.0.0.0/0 |Internet |\",\"DirectEgresstoInternetviaUDR\",\r\nCheckDefRoute contains \"VirtualAppliance\" , \"Internet Sent to Firewall\",\r\nCheckDefRoute ==\"DefaultAzureEgressNoUDR\", \"Azure Default Internet \",\"Unkown\")\r\n| where InternetEgress in (\"{EgressType}\") or '*'   in  ({EgressType}) ",
        "size": 2,
        "title": "Assigned Routes for VNEts/Subnets",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab2"
      },
      "name": "query - 2 - Copy - Copy - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "\r\nresources\r\n| where type == \"microsoft.network/routetables\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| extend routes=properties.routes,hasDefaultRoute=iff(properties.routes contains \"0.0.0.0/0\",true,false)\r\n| project id, name,subscriptionId, routes,hasDefaultRoute\r\n| mv-expand (routes)\r\n| extend  addressPrefix=routes.properties.addressPrefix, nextHopIpAddress=routes.properties.nextHopIpAddress,nextHopType=routes.properties.nextHopType\r\n| where hasDefaultRoute == true\r\n| extend CheckDefRoute=iff(addressPrefix startswith  \"0.0.0.0\" , strcat(addressPrefix,\" |\",nextHopType,\" |\",nextHopIpAddress),\"\")\r\n| where isnotempty( CheckDefRoute)\r\n|summarize CheckDefRoute=make_set(CheckDefRoute) by id, name ,subscriptionId\r\n| summarize Count=count() by tostring(CheckDefRoute)",
        "size": 1,
        "title": "Defined Internet Routes  in Route Tables",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500,
          "sortBy": [
            {
              "itemKey": "Count",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "Count",
            "sortOrder": 2
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "customWidth": "50",
      "name": "query - 2 - Copy - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "\r\nresources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id,name, resourceGroup,subscriptionId,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| mv-expand (subnets)\r\n| extend subnetcidr=subnets.properties.addressPrefix, UDRid=tostring(subnets.properties.routeTable.id),subnetname=subnets.name\r\n| join kind=leftouter \r\n(\r\nresources\r\n| where type == \"microsoft.network/routetables\"\r\n| extend routes=properties.routes,hasDefaultRoute=iff(properties.routes contains \"0.0.0.0/0\",true,false)\r\n| project id, name,subscriptionId, routes,hasDefaultRoute\r\n| mv-expand (routes)\r\n| extend  addressPrefix=routes.properties.addressPrefix, nextHopIpAddress=routes.properties.nextHopIpAddress,nextHopType=routes.properties.nextHopType\r\n| where hasDefaultRoute == true\r\n| extend CheckDefRoute=iff(addressPrefix startswith  \"0.0.0.0\" , strcat(addressPrefix,\" |\",nextHopType,\" |\",nextHopIpAddress),\"\")\r\n|summarize CheckDefRoute=make_set(CheckDefRoute) by id, name ,subscriptionId) on $left.UDRid==$right.id\r\n| project VNETName=name, subscriptionId,subnetname,subnetcidr,UDR=name1,CheckDefRoute=strcat_array(CheckDefRoute,'')\r\n| where isnotempty( CheckDefRoute)\r\n| summarize AssignedSubnets=count(subnetname) by CheckDefRoute\r\n| order by ['AssignedSubnets'] desc",
        "size": 1,
        "title": "Assigned Internet Routes for all Subnets",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500
        },
        "sortBy": []
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab1"
      },
      "customWidth": "50",
      "name": "query - 2 - Copy - Copy - Copy"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "c1bc392b-6b3a-4c19-ae3c-148c2c7b6840",
            "version": "KqlParameterItem/1.0",
            "name": "Direction",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    { \"value\":\"Inbound\", \"label\":\"Inbound\", \"selected\": true },\r\n    { \"value\":\"Outbound\", \"label\":\"Outbound\", \"selected\": false }\r\n]",
            "timeContext": {
              "durationMs": 86400000
            },
            "value": [
              "Inbound",
              "Outbound"
            ]
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "Action",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    { \"value\":\"Allow\", \"label\":\"Allow\", \"selected\": false },\r\n    { \"value\":\"Deny\", \"label\":\"Deny\", \"selected\": true }\r\n]",
            "timeContext": {
              "durationMs": 86400000
            },
            "value": [
              "Deny",
              "Allow"
            ],
            "id": "4c3f2aae-75c3-4e5b-8586-7458867eeb98"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "Source",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where ['type'] ==\"microsoft.network/networksecuritygroups\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id, name,subscriptionId, defaultNSG=properties.defaultSecurityRules,NSGlist=properties.securityRules\r\n| mv-expand (defaultNSG)\r\n| extend destinationAddressPrefixes=defaultNSG.properties.destinationAddressPrefixes, \r\ndestinationAddressPrefix=defaultNSG.properties.destinationAddressPrefix,\r\nsourceAddressPrefixes=defaultNSG.properties.sourceAddressPrefixes,\r\nsourceAddressPrefix=defaultNSG.properties.sourceAddressPrefix,direction=defaultNSG.properties.direction, access=defaultNSG.properties.access\r\n| project NSg=id,subscriptionId,source=iff(isempty(sourceAddressPrefix),sourceAddressPrefixes,sourceAddressPrefix),destination=iff(isempty( destinationAddressPrefix),destinationAddressPrefixes,destinationAddressPrefix)  ,direction,access\r\n| distinct tostring(source)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ],
            "id": "3f69c859-33ad-4cb8-b669-b27517ac1de7"
          },
          {
            "id": "3f69c859-33ad-4cb8-b669-b27517ac1de7",
            "version": "KqlParameterItem/1.0",
            "name": "Destination",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where ['type'] ==\"microsoft.network/networksecuritygroups\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id, name,subscriptionId, defaultNSG=properties.defaultSecurityRules,NSGlist=properties.securityRules\r\n| mv-expand (defaultNSG)\r\n| extend destinationAddressPrefixes=defaultNSG.properties.destinationAddressPrefixes, \r\ndestinationAddressPrefix=defaultNSG.properties.destinationAddressPrefix,\r\nsourceAddressPrefixes=defaultNSG.properties.sourceAddressPrefixes,\r\nsourceAddressPrefix=defaultNSG.properties.sourceAddressPrefix,direction=defaultNSG.properties.direction, access=defaultNSG.properties.access\r\n| project NSg=id,subscriptionId,source=iff(isempty(sourceAddressPrefix),sourceAddressPrefixes,sourceAddressPrefix),destination=iff(isempty( destinationAddressPrefix),destinationAddressPrefixes,destinationAddressPrefix)  ,direction,access\r\n| distinct tostring(destination)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab3"
      },
      "name": "parameters - 19"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/networksecuritygroups\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id, name,subscriptionId, defaultNSG=properties.defaultSecurityRules,NSGlist=properties.securityRules\r\n| mv-expand (defaultNSG)\r\n| extend destinationAddressPrefixes=defaultNSG.properties.destinationAddressPrefixes, \r\ndestinationAddressPrefix=defaultNSG.properties.destinationAddressPrefix,\r\nsourceAddressPrefixes=defaultNSG.properties.sourceAddressPrefixes,\r\nsourceAddressPrefix=defaultNSG.properties.sourceAddressPrefix,direction=defaultNSG.properties.direction, access=defaultNSG.properties.access,sourcePortRange=defaultNSG.properties.sourcePortRange,\r\ndestinationPortRange=defaultNSG.properties.destinationPortRange\r\n| project NSg=id,subscriptionId,source=iff(isempty(sourceAddressPrefix),sourceAddressPrefixes,sourceAddressPrefix),destination=iff(isempty( destinationAddressPrefix),destinationAddressPrefixes,destinationAddressPrefix)  ,direction,access,sourcePortRange,destinationPortRange\r\n| where access  in ({Action:value})\r\n| where direction in ({Direction:value})\r\n| where tostring(source)  in  ({Source:value})   or '*'   in  ({Source}) \r\n| where tostring(destination)  in  ({Destination:value})   or '*'   in  ({Destination}) ",
        "size": 0,
        "title": "All NSG Rules",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab3"
      },
      "name": "query - 2 - Copy - Copy - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/networksecuritygroups\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id, name,subscriptionId, defaultNSG=properties.defaultSecurityRules,NSGlist=properties.securityRules\r\n| mv-expand (NSGlist)\r\n| extend destinationAddressPrefix=tostring(NSGlist.properties.destinationAddressPrefix), sourceAddressPrefix=NSGlist.properties.sourceAddressPrefix,direction=NSGlist.properties.direction, access=NSGlist.properties.access,priority=NSGlist.properties.priority, Rulename =NSGlist.name \r\n| where direction ==\"Outbound\" and ['access'] ==\"Deny\"\r\n| extend rule= strcat(\"Source:\",sourceAddressPrefix,\"  Dest:\",destinationAddressPrefix, \" access:\" , ['access'])\r\n| extend check=case ( destinationAddressPrefix ==\"Internet\" and ['access'] ==\"Deny\",\"DenyInternetbyNSG\",\r\ndestinationAddressPrefix ==\"*\" and ['access'] ==\"Deny\", \"DenyAllOutboundRule\",\"\")\r\n|summarize CheckInternetDeny=make_set(check) by id, name ,subscriptionId\r\n| extend CheckInternetDeny=strcat_array(CheckInternetDeny,\"\")\r\n| where isnotempty( CheckInternetDeny)",
        "size": 1,
        "title": "NSGs with Internet Deny",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab3"
      },
      "name": "query - 2 - Copy - Copy - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id,name, resourceGroup,subscriptionId,location,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| summarize Count=count(id) by DDOS_Enabled=tostring(ddos)",
        "size": 4,
        "title": "DDOS Enabled VNETs",
        "exportFieldName": "DDOS_Enabled",
        "exportParameterName": "DDOS_Enabled",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "true",
              "color": "green"
            },
            {
              "seriesName": "false",
              "color": "orangeDark"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab4"
      },
      "customWidth": "50",
      "name": "query - 2 - Copy - Copy"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "e4448c21-16f4-4b93-907c-31128a7053d7",
            "version": "KqlParameterItem/1.0",
            "name": "DDOS_Enabled",
            "type": 2,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    { \"value\":true, \"label\":\"TRUE\", \"selected\": false },\r\n    { \"value\":false, \"label\":\"FALSE\", \"selected\": true }\r\n]",
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab4"
      },
      "customWidth": "50",
      "name": "parameters - 14"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where ['type'] ==\"microsoft.network/virtualnetworks\"\r\n| where location in ({location})  and subscriptionId in ({Subscription:subid})\r\n| project id,name, resourceGroup,subscriptionId,location,addspace=properties.addressSpace.addressPrefixes,subnets=properties.subnets, ddos=properties.enableDdosProtection,peering=properties.virtualNetworkPeerings\r\n| where ddos == {DDOS_Enabled:label}\r\n| join kind=leftouter  (\r\nresourcecontainers\r\n| where type == \"microsoft.resources/subscriptions\"\r\n| project subscriptionId,SubName=name) on $left.subscriptionId==$right.subscriptionId\r\n| project SubName, id,name, resourceGroup,ddos,subscriptionId,location,addspace,subnets, peering",
        "size": 0,
        "title": "DDOS Enabled VNETs",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "table",
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "SubName",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "SubName",
            "sortOrder": 2
          }
        ],
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "true",
              "color": "green"
            },
            {
              "seriesName": "false",
              "color": "orangeDark"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab4"
      },
      "name": "query - 2 - Copy - Copy - Copy"
    },
    {
      "type": 1,
      "content": {
        "json": "## ðŸŒ Network Topology - Hub & Spoke\r\nThis view shows how your Azure Virtual Networks are connected via VNet Peering with multi-level hub/spoke detection. \r\n**Hub Detection Rules:** \r\nHas a `GatewaySubnet` (VPN/ExpressRoute Gateway)\r\nHas an `AzureFirewallSubnet` \r\nHas 2 or more VNet peerings\r\n**Color Coding:**\r\n\r\nðŸ”µ **Hub** (blue) = VNet identified as a hub (gateway, firewall, or many peerings)\r\n\r\nðŸŸ¢ **Spoke L1** (green) = Directly peered to a Hub VNet\r\n\r\nðŸŸ  **Spoke L2+** (orange) = Peered to a Spoke L1 (spoke-of-spoke, not directly connected to hub)\r\n \r\nðŸ”´ **Isolated** (red) = VNet with no peerings\\r\\n\\r\\nEdge labels show: `GwTransit` = Gateway Transit, `Peering` = Standard peering\""
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab5"
      },
      "name": "text - topology-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// =====================\r\n// NODES\r\n// =====================\r\nresources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| extend peeringCount = array_length(properties.virtualNetworkPeerings)\r\n| extend subnetsStr = tostring(properties.subnets)\r\n| extend hasGatewaySubnet = subnetsStr contains '\"name\":\"GatewaySubnet\"'\r\n| extend hasFirewallSubnet = subnetsStr contains '\"name\":\"AzureFirewallSubnet\"'\r\n| extend isHub = hasGatewaySubnet or hasFirewallSubnet or peeringCount >= 3\r\n| mv-expand p = properties.virtualNetworkPeerings\r\n| extend peerId = tolower(tostring(p.properties.remoteVirtualNetwork.id))\r\n| extend useRemoteGw = tostring(p.properties.useRemoteGateways) == \"true\"\r\n| extend allowGwTransit = tostring(p.properties.allowGatewayTransit) == \"true\"\r\n| summarize\r\n    peerList = make_set(peerId),\r\n    peeringCount = max(peeringCount),\r\n    isHub =countif(isHub) > 0,\r\n    hasGW =countif(hasGatewaySubnet) > 0, \r\n    hasFW = countif(hasFirewallSubnet) > 0,\r\n    usesRemoteGw =countif(useRemoteGw) > 0,\r\n    offersGwTransit =countif(allowGwTransit) > 0, \r\n    vnetName = max(name)\r\n  by vnetId = tolower(id)\r\n// Join to check if any peer is a hub\r\n| mv-expand peerId = peerList\r\n| extend peerId = tostring(peerId)\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.network/virtualnetworks\"\r\n    | extend subnetsStr2 = tostring(properties.subnets)\r\n    | extend peerIsHub = (subnetsStr2 contains '\"name\":\"GatewaySubnet\"')\r\n        or (subnetsStr2 contains '\"name\":\"AzureFirewallSubnet\"')\r\n        or (array_length(properties.virtualNetworkPeerings) >= 3)\r\n    | project peerId = tolower(id), peerIsHub\r\n) on peerId\r\n| summarize\r\n    anyPeerIsHub = countif(peerIsHub) > 0,\r\n    peeringCount = max(peeringCount),\r\n    isHub = countif(isHub) > 0,\r\n    hasGW =countif(hasGW) > 0, \r\n    hasFW = countif(hasFW) > 0,\r\n    vnetName = max(vnetName)\r\n  by vnetId\r\n| extend NodeGroup = case(\r\n    isHub, \"Hub\",\r\n    peeringCount == 0, \"Isolated\",\r\n    anyPeerIsHub, \"SpokeL1\",\r\n    \"SpokeL2\"\r\n  )\r\n| extend hubInfo = case(\r\n    hasGW and hasFW, \"GW+FW\",\r\n    hasGW, \"GW\",\r\n    hasFW, \"FW\",\r\n    isHub, \"MultiPeer\",\r\n    \"\"\r\n  )\r\n| project\r\n    NodeId = vnetId,\r\n    SourceId = \"\",\r\n    TargetId = \"\",\r\n    NodeName = case(\r\n        isHub, strcat(vnetName, \" [Hub:\", hubInfo, \" | \", tostring(peeringCount), \" peers]\"),\r\n        strcat(vnetName, \" [\", tostring(peeringCount), \" peers]\")\r\n    ),\r\n    NodeGroup,\r\n    EdgeLabel = \"\"\r\n| union (\r\n// =====================\r\n// EDGES: All peering relationships (Hub -> peers)\r\n// =====================\r\n    resources\r\n    | where type == \"microsoft.network/virtualnetworks\"\r\n   | where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n    | extend subnetsStr = tostring(properties.subnets)\r\n    | extend isHub = (subnetsStr contains '\"name\":\"GatewaySubnet\"')\r\n        or (subnetsStr contains '\"name\":\"AzureFirewallSubnet\"')\r\n        or (array_length(properties.virtualNetworkPeerings) >= 3)\r\n    | mv-expand p = properties.virtualNetworkPeerings\r\n    | extend remoteVNetId = tolower(tostring(p.properties.remoteVirtualNetwork.id))\r\n    | extend allowGwTransit = tostring(p.properties.allowGatewayTransit) == \"true\"\r\n    | extend allowFwd = tostring(p.properties.allowForwardedTraffic) == \"true\"\r\n    | where isHub\r\n    | project\r\n        NodeId = \"\",\r\n        SourceId = tolower(id),\r\n        TargetId = remoteVNetId,\r\n        NodeName = \"\",\r\n        NodeGroup = \"\",\r\n        EdgeLabel = case(\r\n            allowGwTransit, \"GwTransit\",\r\n            allowFwd, \"Fwd\",\r\n            \"Peering\"\r\n        )\r\n)\r\n| union (\r\n// =====================\r\n// EDGES: Spoke-to-Spoke peering (non-hub to non-hub)\r\n// =====================\r\n    resources\r\n    | where type == \"microsoft.network/virtualnetworks\"\r\n    | where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n    | extend subnetsStr = tostring(properties.subnets)\r\n    | extend isHub = (subnetsStr contains '\"name\":\"GatewaySubnet\"')\r\n        or (subnetsStr contains '\"name\":\"AzureFirewallSubnet\"')\r\n        or (array_length(properties.virtualNetworkPeerings) >= 3)\r\n    | where not(isHub)\r\n    | mv-expand p = properties.virtualNetworkPeerings\r\n    | extend remoteVNetId = tolower(tostring(p.properties.remoteVirtualNetwork.id))\r\n    // Only include edges where remote is also not a hub (spoke-to-spoke)\r\n    | join kind=inner (\r\n        resources\r\n        | where type == \"microsoft.network/virtualnetworks\"\r\n        | extend subnetsStr2 = tostring(properties.subnets)\r\n        | extend remoteIsHub = (subnetsStr2 contains '\"name\":\"GatewaySubnet\"')\r\n            or (subnetsStr2 contains '\"name\":\"AzureFirewallSubnet\"')\r\n            or (array_length(properties.virtualNetworkPeerings) >= 3)\r\n        | where not(remoteIsHub)\r\n        | project remoteVNetId = tolower(id)\r\n    ) on remoteVNetId\r\n    // Deduplicate: only keep edge where source < target\r\n    //| where tolower(id) < remoteVNetId\r\n    | project\r\n        NodeId = \"\",\r\n        SourceId = tolower(id),\r\n        TargetId = remoteVNetId,\r\n        NodeName = \"\",\r\n        NodeGroup = \"\",\r\n        EdgeLabel = \"Spoke-Spoke\"\r\n)",
        "size": 2,
        "title": "VNet Peering Topology - Hub & Spoke",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "graph",
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "NodeName",
            "formatter": 1
          },
          "nodeIdField": "NodeId",
          "sourceIdField": "SourceId",
          "targetIdField": "TargetId",
          "graphOrientation": 2,
          "showOrientationToggles": false,
          "edgeLabel": "EdgeLabel",
          "nodeSize": null,
          "staticNodeSize": 100,
          "colorSettings": {
            "nodeColorField": "NodeGroup",
            "type": 3,
            "thresholdsGrid": [
              {
                "operator": "==",
                "thresholdValue": "Hub",
                "representation": "blue"
              },
              {
                "operator": "==",
                "thresholdValue": "SpokeL1",
                "representation": "green"
              },
              {
                "operator": "==",
                "thresholdValue": "Isolated",
                "representation": "red"
              },
              {
                "operator": "==",
                "thresholdValue": "SpokeL2",
                "representation": "orange"
              }
            ]
          },
          "hivesMargin": 5,
          "edgeColorSettings": null
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab5"
      },
      "name": "query - topology-graph"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand peering = properties.virtualNetworkPeerings\r\n| extend peeringName = tostring(peering.name)\r\n| extend peeringState = tostring(peering.properties.peeringState)\r\n| extend remoteVNet = tostring(peering.properties.remoteVirtualNetwork.id)\r\n| extend remoteVNetName = extract(@\"virtualNetworks/(.+)$\", 1, remoteVNet)\r\n| extend allowForwarded = tostring(peering.properties.allowForwardedTraffic)\r\n| extend allowGateway = tostring(peering.properties.allowGatewayTransit)\r\n| extend useRemoteGw = tostring(peering.properties.useRemoteGateways)\r\n| extend allowVNetAccess = tostring(peering.properties.allowVirtualNetworkAccess)\r\n| project VNetName=name, PeeringName=peeringName, RemoteVNet=remoteVNetName, State=peeringState, AllowForwarded=allowForwarded, GatewayTransit=allowGateway, UseRemoteGateway=useRemoteGw, VNetAccess=allowVNetAccess, subscriptionId",
        "size": 0,
        "title": "VNet Peering Details",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab5"
      },
      "name": "query - peering-details-table"
    },
    {
      "type": 1,
      "content": {
        "json": "## ðŸ”’ Internet Outbound Config for Subnets\r\nSubnets with `defaultOutboundAccess` set to **Disabled/False** are private â€” after March 31st 2026 all subnets will be created as `Private` by default.\r\n\r\nPrivate subnets needs a NAT Gateway, use a NVA or need dedicated public IP in VMs  to be able to reach internet. \r\n- âœ… **NAT Gateway** â€” Recommended for controlled outbound\r\n- âœ… **Firewall (UDR)** â€” 0.0.0.0/0 routed to Virtual Appliance\r\n- âš ï¸ **Direct Internet UDR** â€” 0.0.0.0/0 routed to Internet (not recommended)\r\n- ðŸ”’ **No Outbound Path** â€” Fully isolated, no internet access\r\n\r\nSubnets without the `defaultOutboundAccess` property set are using the legacy Azure default (implicit internet egress)."
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab6"
      },
      "name": "text - private-subnet-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand subnet = properties.subnets\r\n| extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n| extend isPrivate = case(\r\n    defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\", \"Private\",\r\n    defaultOutboundAccess =~ \"true\" or defaultOutboundAccess =~ \"Enabled\", \"Public(DefaultEgress)\",\r\n    \"NotSet(LegacyDefault)\"\r\n  )\r\n| summarize SubnetCount = count() by isPrivate",
        "size": 4,
        "title": "Subnet Privat/Public  Status",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "Private",
              "color": "blue"
            },
            {
              "seriesName": "Public(DefaultEgress)",
              "color": "orange"
            },
            {
              "seriesName": "NotSet(LegacyDefault)",
              "color": "gray"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab6"
      },
      "customWidth": "33",
      "name": "query - private-subnet-piechart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand subnet = properties.subnets\r\n| extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n| extend natGatewayId = tostring(subnet.properties.natGateway.id)\r\n| extend routeTableId = tostring(subnet.properties.routeTable.id)\r\n| extend isPrivate = defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\"\r\n| extend hasNatGateway = isnotempty(natGatewayId)\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.network/routetables\"\r\n    | mv-expand route = properties.routes\r\n    | where tostring(route.properties.addressPrefix) == \"0.0.0.0/0\"\r\n    | project routeTableId = id,\r\n        nextHopType = tostring(route.properties.nextHopType),\r\n        nextHopIp = tostring(route.properties.nextHopIpAddress)\r\n) on routeTableId\r\n| extend hasInternetUDR = isnotempty(nextHopType)\r\n| extend OutboundStatus = case(\r\n    isPrivate and hasNatGateway, \"Private+NATGateway\",\r\n    isPrivate and hasInternetUDR and nextHopType == \"VirtualAppliance\", \"Private+Firewall\",\r\n    isPrivate and hasInternetUDR and nextHopType == \"Internet\", \"Private+DirectInternetUDR\",\r\n    isPrivate and not(hasNatGateway) and not(hasInternetUDR), \"Private-NoOutbound\",\r\n    not(isPrivate), \"NotPrivate\",\r\n    \"Unknown\"\r\n  )\r\n| where isPrivate\r\n| summarize SubnetCount = count() by OutboundStatus",
        "size": 4,
        "title": "Private Subnet Outbound Paths",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "Private+NATGateway",
              "color": "green"
            },
            {
              "seriesName": "Private+Firewall",
              "color": "blue"
            },
            {
              "seriesName": "Private+DirectInternetUDR",
              "color": "orange"
            },
            {
              "seriesName": "Private-NoOutbound",
              "color": "redBright"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab6"
      },
      "customWidth": "33",
      "name": "query - private-outbound-piechart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand subnet = properties.subnets\r\n| extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n| extend isPrivate = defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\"\r\n| summarize TotalSubnets = count(), PrivateSubnets = countif(isPrivate), NonPrivateSubnets = countif(not(isPrivate)) by VNetName = name, subscriptionId\r\n| extend PrivatePercent = round(100.0 * PrivateSubnets / TotalSubnets, 1)\r\n| project VNetName, TotalSubnets, PrivateSubnets, NonPrivateSubnets, PrivatePercent, subscriptionId\r\n| order by PrivatePercent desc",
        "size": 4,
        "title": "Private Subnet Coverage by VNet",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "tiles",
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "VNetName",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "PrivatePercent",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 1,
              "options": {
                "maximumFractionDigits": 1
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab6"
      },
      "customWidth": "33",
      "name": "query - private-coverage-tiles"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand subnet = properties.subnets\r\n| extend subnetName = tostring(subnet.name)\r\n| extend subnetCidr = tostring(subnet.properties.addressPrefix)\r\n| extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n| extend natGatewayId = tostring(subnet.properties.natGateway.id)\r\n| extend routeTableId = tostring(subnet.properties.routeTable.id)\r\n| extend isPrivate = case(\r\n    defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\", true,\r\n    false\r\n  )\r\n| extend hasNatGateway = isnotempty(natGatewayId)\r\n| extend natGatewayName = iff(hasNatGateway, extract(@\"natGateways/(.+)$\", 1, natGatewayId), \"None\")\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.network/routetables\"\r\n    | mv-expand route = properties.routes\r\n    | where tostring(route.properties.addressPrefix) == \"0.0.0.0/0\"\r\n    | project routeTableId = id,\r\n        routeTableName = name,\r\n        nextHopType = tostring(route.properties.nextHopType),\r\n        nextHopIp = tostring(route.properties.nextHopIpAddress)\r\n) on routeTableId\r\n| extend hasInternetUDR = isnotempty(nextHopType)\r\n| extend internetRoute = case(\r\n    isnotempty(nextHopIp), strcat(nextHopType, \" -> \", nextHopIp),\r\n    isnotempty(nextHopType), nextHopType,\r\n    \"None\"\r\n  )\r\n| extend OutboundStatus = case(\r\n    isPrivate and hasNatGateway, \"âœ… Private + NAT Gateway\",\r\n    isPrivate and hasInternetUDR and nextHopType == \"VirtualAppliance\", \"âœ… Private + Firewall\",\r\n    isPrivate and hasInternetUDR and nextHopType == \"Internet\", \"âš ï¸ Private + Direct Internet UDR\",\r\n    isPrivate and not(hasNatGateway) and not(hasInternetUDR), \"ðŸ”’ Private - No Outbound Path\",\r\n    not(isPrivate) and hasNatGateway, \"NAT Gateway (Not Private)\",\r\n    not(isPrivate) and hasInternetUDR, \"UDR Egress (Not Private)\",\r\n    not(isPrivate), \"Default Azure Egress (Not Private)\",\r\n    \"Unknown\"\r\n  )\r\n| project VNetName = name, SubnetName = subnetName, SubnetCIDR = subnetCidr,\r\n    IsPrivate = isPrivate, NATGateway = natGatewayName,\r\n    InternetUDR = internetRoute, OutboundStatus,\r\n    subscriptionId\r\n| order by IsPrivate desc, OutboundStatus asc",
        "size": 0,
        "title": "All Subnets - Private Status & Outbound Path Detail",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "rowLimit": 1000,
          "sortBy": [
            {
              "itemKey": "OutboundStatus",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "OutboundStatus",
            "sortOrder": 2
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab6"
      },
      "name": "query - private-subnet-detail-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// NODES: Outbound categories with specific FW IP / NAT GW name\r\nresources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n| mv-expand subnet = properties.subnets\r\n| extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n| extend natGatewayId = tostring(subnet.properties.natGateway.id)\r\n| extend routeTableId = tostring(subnet.properties.routeTable.id)\r\n| extend isPrivate = defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\"\r\n| extend hasNatGateway = isnotempty(natGatewayId)\r\n| extend natGwName = iff(hasNatGateway, extract(@\"natGateways/(.+)$\", 1, natGatewayId), \"\")\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.network/routetables\"\r\n    | mv-expand route = properties.routes\r\n    | where tostring(route.properties.addressPrefix) == \"0.0.0.0/0\"\r\n    | project routeTableId = id,\r\n        nextHopType = tostring(route.properties.nextHopType),\r\n        nextHopIp = tostring(route.properties.nextHopIpAddress)\r\n) on routeTableId\r\n| extend hasInternetUDR = isnotempty(nextHopType)\r\n| extend OutboundTarget = case(\r\n    isPrivate and hasNatGateway, strcat(\"NATGateway: \", natGwName),\r\n    isPrivate and hasInternetUDR and nextHopType == \"VirtualAppliance\", strcat(\"Firewall: \", nextHopIp),\r\n    isPrivate and hasInternetUDR and nextHopType == \"Internet\", \"DirectInternetUDR\",\r\n    isPrivate and not(hasNatGateway) and not(hasInternetUDR), \"NoOutboundPath\",\r\n    not(isPrivate), \"NotPrivate-DefaultEgress\",\r\n    \"Unknown\"\r\n  )\r\n| extend CategoryGroup = case(\r\n    OutboundTarget startswith \"NATGateway\", \"NATGateway\",\r\n    OutboundTarget startswith \"Firewall\", \"Firewall\",\r\n    OutboundTarget == \"DirectInternetUDR\", \"Warning\",\r\n    OutboundTarget == \"NoOutboundPath\", \"Locked\",\r\n    OutboundTarget startswith \"NotPrivate\", \"NotPrivate\",\r\n    \"Other\"\r\n  )\r\n// Now enrich NAT Gateway nodes with public IP\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.network/natgateways\"\r\n    | mv-expand pip = properties.publicIpAddresses\r\n    | extend pipId = tostring(pip.id)\r\n    | join kind=leftouter (\r\n        resources\r\n        | where type == \"microsoft.network/publicipaddresses\"\r\n        | project pipId = id, publicIp = tostring(properties.ipAddress)\r\n    ) on pipId\r\n    | project natGatewayId = id, natGwPublicIp = publicIp\r\n) on natGatewayId\r\n| extend NodeName = case(\r\n    OutboundTarget startswith \"NATGateway\" and isnotempty(natGwPublicIp),\r\n        strcat(OutboundTarget, \" (\", natGwPublicIp, \")\"),\r\n    OutboundTarget\r\n  )\r\n| distinct OutboundTarget, NodeName, CategoryGroup\r\n| project NodeId = OutboundTarget, NodeName, NodeGroup = CategoryGroup,\r\n    SourceId = \"\", TargetId = \"\", EdgeLabel = \"\"\r\n| union (\r\n    // NODES: VNets that have private subnets\r\n    resources\r\n    | where type == \"microsoft.network/virtualnetworks\"\r\n    | where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n    | mv-expand subnet = properties.subnets\r\n    | extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n    | extend isPrivate = defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\"\r\n    | where isPrivate\r\n    | extend addressSpace = tostring(properties.addressSpace.addressPrefixes)\r\n    | project NodeId = id, NodeName = strcat(name, \" [\", addressSpace, \"]\"),\r\n        NodeGroup = \"PrivateVNet\",\r\n        SourceId = \"\", TargetId = \"\", EdgeLabel = \"\"\r\n    | distinct NodeId, NodeName, NodeGroup, SourceId, TargetId, EdgeLabel\r\n)\r\n| union (\r\n    // EDGES: OutboundTarget -> VNet with subnet count\r\n    resources\r\n    | where type == \"microsoft.network/virtualnetworks\"\r\n    | where location in ({location}) and subscriptionId in ({Subscription:subid})\r\n    | mv-expand subnet = properties.subnets\r\n    | extend defaultOutboundAccess = tostring(subnet.properties.defaultOutboundAccess)\r\n    | extend natGatewayId = tostring(subnet.properties.natGateway.id)\r\n    | extend routeTableId = tostring(subnet.properties.routeTable.id)\r\n    | extend isPrivate = defaultOutboundAccess =~ \"false\" or defaultOutboundAccess =~ \"Disabled\"\r\n    | extend hasNatGateway = isnotempty(natGatewayId)\r\n    | extend natGwName = iff(hasNatGateway, extract(@\"natGateways/(.+)$\", 1, natGatewayId), \"\")\r\n    | join kind=leftouter (\r\n        resources\r\n        | where type == \"microsoft.network/routetables\"\r\n        | mv-expand route = properties.routes\r\n        | where tostring(route.properties.addressPrefix) == \"0.0.0.0/0\"\r\n        | project routeTableId = id,\r\n            nextHopType = tostring(route.properties.nextHopType),\r\n            nextHopIp = tostring(route.properties.nextHopIpAddress)\r\n    ) on routeTableId\r\n    | extend hasInternetUDR = isnotempty(nextHopType)\r\n    | extend OutboundTarget = case(\r\n        isPrivate and hasNatGateway, strcat(\"NATGateway: \", natGwName),\r\n        isPrivate and hasInternetUDR and nextHopType == \"VirtualAppliance\", strcat(\"Firewall: \", nextHopIp),\r\n        isPrivate and hasInternetUDR and nextHopType == \"Internet\", \"DirectInternetUDR\",\r\n        isPrivate and not(hasNatGateway) and not(hasInternetUDR), \"NoOutboundPath\",\r\n        not(isPrivate), \"NotPrivate-DefaultEgress\",\r\n        \"Unknown\"\r\n      )\r\n    | summarize PrivateSubnets = count() by VNetId = id, OutboundTarget\r\n    | project NodeId = \"\", NodeName = \"\", NodeGroup = \"\",\r\n        SourceId = OutboundTarget, TargetId = VNetId,\r\n        EdgeLabel = strcat(tostring(PrivateSubnets), \" subnets\")\r\n)",
        "size": 3,
        "title": "Private Subnet Outbound Topology",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "graph",
        "graphSettings": {
          "type": 0,
          "topContent": {
            "formatter": 1,
            "numberFormat": {
              "unit": 0,
              "options": {
                "style": "decimal"
              }
            }
          },
          "centerContent": {
            "columnMatch": "NodeName"
          },
          "nodeIdField": "NodeId",
          "sourceIdField": "SourceId",
          "targetIdField": "TargetId",
          "graphOrientation": 2,
          "showOrientationToggles": false,
          "edgeLabel": "EdgeLabel",
          "nodeSize": null,
          "staticNodeSize": 100,
          "colorSettings": {
            "nodeColorField": "NodeGroup",
            "type": 3,
            "thresholdsGrid": [
              {
                "operator": "==",
                "thresholdValue": "NATGateway",
                "representation": "green"
              },
              {
                "operator": "==",
                "thresholdValue": "Firewall",
                "representation": "blue"
              },
              {
                "operator": "==",
                "thresholdValue": "Warning",
                "representation": "orange"
              },
              {
                "operator": "==",
                "thresholdValue": "Locked",
                "representation": "redBright"
              },
              {
                "operator": "==",
                "thresholdValue": "NotPrivate",
                "representation": "gray"
              },
              {
                "operator": "==",
                "thresholdValue": "PrivateVNet",
                "representation": "turquoise"
              }
            ]
          },
          "hivesMargin": 5,
          "edgeColorSettings": null
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "tab6"
      },
      "name": "query - private-subnet-graph"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
