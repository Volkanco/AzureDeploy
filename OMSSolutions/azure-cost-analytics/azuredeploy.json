{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "logAnalyticsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Create new or use an existing Log Analytic Workspace"
            }
        },
        "logAnalyticsRegion": {
            "type": "string",
            "allowedValues": [
               "East US",
                "West Europe",
                "Southeast Asia",
                "Australia Southeast",
                "West Central US",
                "Japan East",
                "UK South",
                "Central India",
                "Canada Central",
                "East US 2 EUAP",
                "West US 2",
                "Australia Central",
                "Australia East",
                "France Central",
                "Korea Central",
                "North Europe",
                "Central US",
                "East Asia",
                "East US 2",
                "South Central US",
                "North Central US",
                "West US",
                "UK West",
                "South Africa North",
                "Brazil South",
                "Switzerland North",
                "Switzerland West"
            ],
            "metadata": {
                "description": "Specify the Azure Region for your new or existing OMS workspace"
            }
        },
         "automationAccountName": {
            "type": "string",
            "metadata": {
                "description": "Use an existing Automation account or create a new"
            }
        },
        "automationRegion": {
            "type": "string",
            "allowedValues": [
                "Japan East",
                "East US 2",
                "West Europe",
                "South Africa North",
                "UK West",
                "Switzerland North",
                "Southeast Asia",
                "South Central US",
                "North Central US",
                "East Asia",
                "Central US",
                "West US",
                "Australia Central",
                "Australia East",
                "Korea Central",
                "East US",
                "West US 2",
                "Brazil South",
                "Central US EUAP",
                "UK South",
                "West Central US",
                "North Europe",
                "Canada Central",
                "Australia Southeast",
                "Central India",
                "France Central"
            ],
            "metadata": {
                "description": "Specify the Azure Region for your OMS Automation Account"
            }
        },  
        "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    },  
      "ingestSchedulerGuid": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
     ,
        "_artifactsLocation": {
            "type": "string",
            "defaultValue": "https://raw.githubusercontent.com/Volkanco/AzureDeploy/master/OMSSolutions/azure-cost-analytics",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located"
            }
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
            }
        }
    },
    "variables": {
        "runbooks": {
            "ingestParentRunbook": {
                "name": "AzureUsageCollector",
                "version": "1.0.0.2",
                "description": "Runbook to collect Azure Usage    into Log Analytics",
                "type": "PowerShell",
                "Id": ""
            }
        },
        "parentRunbookUri": "[concat(parameters('_artifactsLocation'),'/scripts/get-AzureUsage.ps1', parameters('_artifactsLocationSasToken'))]",
        "omsSolutions": {
            "customSolution": {
                "name": "Azure Cost Analytics",
                "solutionName": "[concat('AzureCostAnalytics', '[', parameters('logAnalyticsWorkspaceName'), ']')]",
                "publisher": "volkanc@microsoft.com",
                "displayName": "Azure Cost Analytics",
                "description": "Monitor Azure usage  accross management Groups and subscriptions",
                "author": "volkanc@microsoft.com"
            }
        },
            "AZMONWorkspaceID": "AzureCostAnalytics-AZMON_WS_ID",
        "AZMONWorkspaceIDType": "string",
        "AZMONWorkspaceIDDescription": "Value of the user's Azure Monitor",
        "AZMONWorkspaceKey": "AzureCostAnalytics-AZMON_WS_KEY",
        "AZMONWorkspaceKeyType": "string",
        "AZMONWorkspaceKeyDescription": "Encrypted value of the user's omsWorkspaceKey",
        "createScheduleAutomationAccountName": "AzureCostAnalytics-AzureAutomationAccount-MS-Mgmt",
        "createScheduleAutomationAccountType": "string",
        "createScheduleAutomationAccountDescription": "The name of the Automation Account",
        "createScheduleResourceGroupName": "AzureCostAnalytics-AzureAutomationResourceGroup-MS-Mgmt",
        "createScheduleResourceGroupType": "string",
        "createScheduleResourceGroupDescription": "The name of the resource group",
             "SchedulerFrequency": "Daily",
            "ingestScheduleName": "AzureUsage-Scheduler-Daily",
        "ingestInterval": "1",
        "ingestFrequency": "day",
        "automationSKU": "basic",
        "logAnalyticsSku":"pergb2018",
            "alertArray": [
          ],
          "workbookDisplayName":"Azure Consumption v2",
          "workbookType":"workbook",
          "workbookSourceId":"Azure Monitor"
    },
    "resources": [
                {
            "name": "[parameters('logAnalyticsWorkspaceName')]",
            "type": "Microsoft.OperationalInsights/workspaces",
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('logAnalyticsRegion')]",
            "properties": {
            },
            "resources":[
               ]            
        },
        {
            "apiversion": "2015-10-31",
            "location": "[parameters('automationRegion')]",
            "name": "[parameters('automationAccountName')]",
            "type": "Microsoft.Automation/automationAccounts",
            "properties": {
                "sku": {
                    "name": "[variables('automationSKU')]"
                }
            },
            "resources": [
                {
                    "name": "[variables('AZMONWorkspaceID')]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('AZMONWorkspaceIDDescription')]",
                        "isEncrypted": 0,
                        "type": "[variables('AZMONWorkspaceIDType')]",
                        "value": "[concat('\"',reference(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('logAnalyticsWorkspaceName')), '2015-11-01-preview').customerId,'\"')]"
                    }
                },
                {
                    "name": "[variables('AZMONWorkspaceKey')]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('AZMONWorkspaceKeyDescription')]",
                        "isEncrypted": 1,
                        "type": "[variables('AZMONWorkspaceKeyType')]",
                        "value": "[concat('\"',listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('logAnalyticsWorkspaceName')), '2015-11-01-preview').primarySharedKey,'\"')]"
                    }
                },
                {
                    "name": "[variables('createScheduleAutomationAccountName')]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('createScheduleAutomationAccountDescription')]",
                        "isEncrypted": 0,
                        "type": "[variables('createScheduleAutomationAccountType')]",
                        "value": "[concat('\"', parameters('automationAccountName'),'\"')]"
                    }
                },
                {
                    "name": "[variables('createScheduleResourceGroupName')]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('createScheduleResourceGroupDescription')]",
                        "isEncrypted": 0,
                        "type": "[variables('createScheduleResourceGroupType')]",
                        "value": "[concat('\"', resourceGroup().name, '\"')]"
                    }
                },
                {
                    "name": "[variables('runbooks').ingestParentRunbook.name]",
                    "type": "runbooks",
                    "apiVersion": "2015-10-31",
                    "location": "[parameters('automationRegion')]",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'), '/variables/', variables('AZMONWorkspaceID'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'), '/variables/', variables('AZMONWorkspaceKey'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "runbookType": "[variables('runbooks').ingestParentRunbook.type]",
                        "logProgress": "false",
                        "logVerbose": "false",
                        "description": "[variables('runbooks').ingestParentRunbook.description]",
                        "publishContentLink": {
                            "uri": "[variables('parentRunbookUri')]",
                            "version": "[variables('runbooks').ingestParentRunbook.version]"
                        }
                    }
                },
                {
                    "name": "[concat(parameters('automationAccountName'), '/', variables('ingestscheduleName'))]",
                    "type": "microsoft.automation/automationAccounts/schedules",
                    "apiVersion": "2015-10-31",
                    "location": "[parameters('automationRegion')]",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'), '/runbooks/', variables('runbooks').ingestParentRunbook.name)]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "OMS Azure Storage Runbook Scheduler",
                        "startTime": "15:00",
                        "isEnabled": "true",
                        "interval": "[variables('ingestInterval')]",
                        "frequency": "[variables('ingestFrequency')]"
                    }
                },
                {
                    "name": "[concat(parameters('automationAccountName'), '/',parameters('ingestSchedulerGuid'))]",
                    "type": "microsoft.automation/automationAccounts/jobSchedules",
                    "apiVersion": "2015-10-31",
                    "location": "[parameters('automationRegion')]",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'), '/schedules/', variables('ingestscheduleName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'), '/runbooks/', variables('runbooks').ingestParentRunbook.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "schedule": {
                            "name": "[variables('ingestscheduleName')]"
                        },
                        "runbook": {
                            "name": "[variables('Runbooks').ingestParentRunbook.name]"
                        },
                        "parameters": {
                               }
                    }
                }
            ]
        },
        {
            "name": "[variables('omsSolutions').customSolution.solutionName]",
            "type": "Microsoft.OperationsManagement/solutions",
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('logAnalyticsRegion')]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('logAnalyticsWorkspaceName'))]",
                "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]",
                "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'), '/runbooks/', variables('runbooks').ingestParentRunbook.name)]"
            ],
            "plan": {
                "name": "[variables('omsSolutions').customSolution.solutionName]",
                "product": "[variables('omsSolutions').customSolution.name]",
                "publisher": "[variables('omsSolutions').customSolution.publisher]",
                "promotionCode": ""
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('logAnalyticsWorkspaceName'))]",
                "referencedResources": [],
                "containedResources": [
                    "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('logAnalyticsWorkspaceName'), variables('omsSolutions').customSolution.name)]",
                    "[resourceId('Microsoft.Automation/automationAccounts/runbooks/', parameters('automationAccountName'), variables('runbooks').ingestParentRunbook.name)]",
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('automationAccountName'), variables('AZMONWorkspaceID'))]",
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('automationAccountName'), variables('AZMONWorkspaceKey'))]",
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('automationAccountName'), variables('createScheduleAutomationAccountName'))]",
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('automationAccountName'), variables('createScheduleResourceGroupName'))]"
                ]
            }
        },
            {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "kind": "shared",
            "properties": {
        "displayName": "[variables('workbookDisplayName')]",
       "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Cost Analytics\\n---\\n\\n\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"14c296cc-face-4041-8f40-716a05dbe332\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| summarize by id, name\\r\\n| project id\",\"crossComponentResources\":[\"value::all\"],\"value\":\"/subscriptions/2de20a16-20c6-41af-82cd-bceb39195d1c/resourceGroups/rg-shared-sc-weu/providers/Microsoft.OperationalInsights/workspaces/la-prod-sc-weu\",\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"191cdc7f-3689-4f79-8f3f-02114bdb2117\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"subscription\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated > ago(30d)\\r\\n| project Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s \\r\\n| where isnotempty(Subscription)\\r\\n| distinct Subscription, SubscriptionName\",\"crossComponentResources\":[\"{Workspace}\"],\"value\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.resources/subscriptions\":true},\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"073783b8-2700-4b6b-b23a-5edefdf72797\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"resourceType\":\"microsoft.insights/components\"},{\"id\":\"5f1933bd-86d2-432e-b796-7487ce0c1c9c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeoffset\",\"type\":1,\"value\":\"4\",\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"condition\":\"else result = '4'\",\"criteriaContext\":{\"operator\":\"Default\",\"rightValType\":\"param\",\"resultValType\":\"static\",\"resultVal\":\"4\"}}],\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"resourceType\":\"microsoft.insights/components\"},{\"id\":\"5c4bd89c-0681-447d-96b3-70cd2e60673a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"shownori\",\"type\":1,\"value\":\"0\",\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"condition\":\"else result = '0'\",\"criteriaContext\":{\"operator\":\"Default\",\"rightValType\":\"param\",\"resultValType\":\"static\",\"resultVal\":\"0\"}}],\"resourceType\":\"microsoft.insights/components\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\"},\"name\":\"parameters - 2\"},{\"type\":1,\"content\":{\"json\":\"Select the workspace  where Azure Usage data is ingested !\\r\\nOnly subscriptions with usage data displayed in subscription selection!\"},\"name\":\"text - 26\"},{\"type\":1,\"content\":{\"json\":\"# Overall Usage  \\r\\n\\r\\n\"},\"name\":\"text - 18\"},{\"type\":1,\"content\":{\"json\":\"**Usage This Month**    |   **Usage Last Month Same Day** <br>\\r\\n\\r\\n**Total Last Month**\"},\"name\":\"text - 26\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let day=dayofmonth(now());\\r\\nlet start= startofmonth(datetime_add('month',-1,now())) ;\\r\\nlet end =   datetime_add('day',day,start );\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= startofmonth(now())\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize ThisMCost=round(sum(PretaxCost_d),4)  by  Sub=\\\"Parent\\\"\\r\\n| join kind=leftouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= start\\r\\n| where TimeGenerated  < end\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize PrevMSameDayCost=round(sum(PretaxCost_d),0) by Sub=\\\"Parent\\\"\\r\\n) on Sub\\r\\n| join kind=leftouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= start\\r\\n| where TimeGenerated  < startofmonth(now())\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize PrevMTotal=round(sum(PretaxCost_d),0) by  Sub=\\\"Parent\\\"\\r\\n) on Sub\\r\\n| project  Subscription=\\\"TotaL\\\",ThisMCost, PrevMSameDayCost, PrevMTotal\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Total Usage \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SubscriptionName\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"ThisMCost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"PrevMSameDayCost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},\"secondaryContent\":{\"columnMatch\":\"PrevMTotal\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false}},\"customWidth\":\"20\",\"name\":\"query - 25 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let day=dayofmonth(now());\\r\\nlet start= startofmonth(datetime_add('month',-1,now())) ;\\r\\nlet end =   datetime_add('day',day,start );\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= startofmonth(now())\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize ThisMCost=round(sum(PretaxCost_d),4) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s\\r\\n| join kind=leftouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= start\\r\\n| where TimeGenerated  < end\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize PrevMSameDayCost=round(sum(PretaxCost_d),0) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s\\r\\n) on Subscription\\r\\n| join kind=leftouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= start\\r\\n| where TimeGenerated  < startofmonth(now())\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize PrevMTotal=round(sum(PretaxCost_d),0) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s\\r\\n) on Subscription\\r\\n| project  Subscription, SubscriptionName , ThisMCost, PrevMSameDayCost, PrevMTotal\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Usage (Prev Month - Same Day)\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SubscriptionName\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"ThisMCost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"PrevMSameDayCost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},\"secondaryContent\":{\"columnMatch\":\"PrevMTotal\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false}},\"customWidth\":\"80\",\"name\":\"query - 25 - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"loadType\":\"always\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{vmsize}\\r\\nvmsize\",\"size\":0,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"sizes\"}]},\"conditionalVisibility\":{\"parameterName\":\"showhidden\",\"comparison\":\"isNotEqualTo\"},\"name\":\"hidden\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let timerange=30d;\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by ConsumedService=ConsumedService_s , Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s\\r\\n\",\"size\":0,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"showhidden\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by ConsumedService=ConsumedService_s , Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s\\r\\n| sort by Cost desc\",\"size\":2,\"title\":\"Usage by ConsumedService\",\"exportFieldName\":\"ConsumedService\",\"exportParameterName\":\"ConsumedService\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"graph\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"centerContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"hivesContent\":{\"columnMatch\":\"SubscriptionName\",\"formatter\":1,\"formatOptions\":{}},\"nodeIdField\":\"ConsumedService\",\"nodeSize\":null,\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"Cost\",\"type\":1,\"colorPalette\":\"default\",\"emptyValueColor\":\"gray\"},\"groupByField\":\"SubscriptionName\",\"hivesMargin\":5}},\"name\":\"query - 11 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let trends=AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| make-series CostTrend=round(sum(PretaxCost_d),4) default=double(0) on TimeGenerated in range({TimeRange:start},now(), 1d) by ConsumedService=ConsumedService_s; //, Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s;\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by ConsumedService=ConsumedService_s //, Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s  \\r\\n| join kind= leftouter (trends ) on ConsumedService //,Subscription\\r\\n//| project-away Subscription1, SubscriptionName1\",\"size\":0,\"title\":\"Usage Trends -  Select a Service to see details\",\"exportFieldName\":\"ConsumedService\",\"exportParameterName\":\"ConsumedService\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"ConsumedService1\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"CostTrend\",\"formatter\":10,\"formatOptions\":{}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5,\"formatOptions\":{}}],\"sortBy\":[{\"itemKey\":\"$gen_bar_Cost_1\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_Cost_1\",\"sortOrder\":2}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 11 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| where ConsumedService_s == \\\"{ConsumedService}\\\"\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by  InstanceName_s , bin(TimeGenerated,1d)\\r\\n\",\"size\":0,\"aggregation\":3,\"title\":\"Usage Trends for Selected Service\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"timechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 11 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| summarize Usage = round(sum(PretaxCost_d),4) by Id=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s ,ParentId = ''\\r\\n| extend Kind = 'Usage', Name = strcat('🔑 Sub-', SubscriptionName) \\r\\n| union (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where isnotempty(Tags_s)\\r\\n| mv-expand Tags=parse_json(Tags_s)\\r\\n| summarize Usage = round(sum(PretaxCost_d),4) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s ,ParentId = SubscriptionGuid_g ,  Id=strcat(SubscriptionGuid_g ,'\\\\\\\\',tostring(Tags)),tostring(Tags)\\r\\n| extend Kind = 'Usage', Name = strcat('🏷 Tag-', tostring(Tags)) )\\r\\n\",\"size\":0,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"SubscriptionName\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Usage\",\"formatter\":4,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"Subscription\",\"formatter\":5,\"formatOptions\":{}}],\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":true}}},\"name\":\"query - 30\"},{\"type\":1,\"content\":{\"json\":\"# Usage Trends \\r\\n## This Month vs Last  Month\"},\"name\":\"text - 22\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let day=dayofmonth(now());\\r\\nlet start= startofmonth(datetime_add('month',-1,now())) ;\\r\\nlet end =   datetime_add('day',day,start );\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= startofmonth(now())\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize ThisMCost=round(sum(PretaxCost_d),4) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s, ConsumedService=ConsumedService_s\\r\\n| join kind=leftouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= start\\r\\n| where TimeGenerated  < end\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize PrevMSameDayCost=round(sum(PretaxCost_d),0) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s,ConsumedService=ConsumedService_s\\r\\n) on Subscription, ConsumedService\\r\\n| join kind=leftouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= start\\r\\n| where TimeGenerated  < startofmonth(now())\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize PrevMTotal=round(sum(PretaxCost_d),0) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s, ConsumedService=ConsumedService_s\\r\\n) on Subscription, ConsumedService\\r\\n| project  Subscription, SubscriptionName , ThisMCost, PrevMSameDayCost, PrevMTotal, ConsumedService\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"Usage Trends- Month over Month\",\"exportFieldName\":\"ConsumedService\",\"exportParameterName\":\"ConsumedService\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\",\"useGrouping\":false,\"minimumIntegerDigits\":1,\"maximumFractionDigits\":1,\"minimumSignificantDigits\":1,\"maximumSignificantDigits\":1}}},{\"columnMatch\":\"ConsumedService1\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"ConsumedService2\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"CostTrend\",\"formatter\":10,\"formatOptions\":{}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5,\"formatOptions\":{}}],\"sortBy\":[{\"itemKey\":\"$gen_bar_Cost_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\"},{\"columnId\":\"SubscriptionName\"},{\"columnId\":\"ConsumedService\"}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_Cost_3\",\"sortOrder\":2}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"ConsumedService\",\"yAxis\":[\"PrevMSameDayCost\",\"PrevMTotal\",\"ThisMCost\"],\"showLegend\":true,\"seriesLabelSettings\":[{\"seriesName\":\"ThisMCost\",\"color\":\"blue\"},{\"seriesName\":\"PrevMSameDayCost\",\"color\":\"yellow\"},{\"seriesName\":\"PrevMTotal\",\"color\":\"redDark\"}],\"xSettings\":{},\"ySettings\":{}}},\"name\":\"query - 11 - Copy - Copy - Copy - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"513d085c-2b09-4b06-9c84-7c713edc6b3c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ComparisionPeriod\",\"type\":2,\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[\\r\\n    { \\\"value\\\":\\\"Day over Day\\\", \\\"label\\\":\\\"DoD\\\", \\\"selected\\\": true },\\r\\n    { \\\"value\\\":\\\"Week over Week\\\", \\\"label\\\":\\\"WoW\\\", \\\"selected\\\": false },\\r\\n    { \\\"value\\\":\\\"Month Over Month\\\", \\\"label\\\":\\\"MoM\\\", \\\"selected\\\": false }\\r\\n]\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"resourceType\":\"microsoft.insights/components\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\"},\"name\":\"parameters - 24\"},{\"type\":1,\"content\":{\"json\":\"# Cost Difference {ComparisionPeriod} \"},\"name\":\"text - 25\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s, TimeGenerated \\r\\n| sort by Subscription, SubscriptionName, TimeGenerated asc\\r\\n| serialize\\r\\n|  extend  p_cost = iff(Subscription==prev(Subscription) , p_cost = prev(Cost,1) , p_cost=Cost)\\r\\n| project   Subscription , SubscriptionName , TimeGenerated=datetime_add('hour',-1*{timeoffset},TimeGenerated) , Cost , p_cost , cost_diff=Cost-p_cost, cost_pctdiff=round((Cost/p_cost)*100-100,1)\\r\\n| sort by cost_diff desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Cost Diff DoD\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":1,\"formatOptions\":{}},{\"columnMatch\":\"Subscription\",\"formatter\":1,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"p_cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"yellow\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"cost_diff\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"cost_pctdiff\",\"formatter\":0,\"formatOptions\":{},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"InstanceName_s\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"MeterId_g\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}],\"rowLimit\":500,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"SubscriptionName\"]},\"sortBy\":[{\"itemKey\":\"TimeGenerated\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"TimeGenerated\",\"sortOrder\":1}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"InstanceName_s\"],\"seriesLabelSettings\":[{\"seriesName\":\"Cost\",\"color\":\"blue\"},{\"seriesName\":\"p_cost\",\"color\":\"yellow\"},{\"seriesName\":\"cost_diff\",\"color\":\"redBright\"}],\"xSettings\":{},\"ySettings\":{}}},\"conditionalVisibility\":{\"parameterName\":\"ComparisionPeriod\",\"comparison\":\"isEqualTo\",\"value\":\"Day over Day\"},\"name\":\"DoD \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by InstanceId_s, InstanceName_s ,MeterId_g,Product_s, Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s, TimeGenerated \\r\\n| sort by Subscription ,InstanceName_s,MeterId_g,Product_s,  TimeGenerated asc\\r\\n| serialize\\r\\n|  extend  p_cost = iff(InstanceId_s==prev(InstanceId_s) and MeterId_g==prev(MeterId_g), p_cost = prev(Cost,1) , p_cost=Cost)\\r\\n| project  InstanceId_s, InstanceName_s, Subscription , SubscriptionName , TimeGenerated=datetime_add('hour',-1*{timeoffset},TimeGenerated) ,MeterId_g,Product_s, Cost , p_cost , cost_diff=Cost-p_cost, cost_pctdiff=round((Cost/p_cost)*100-100,1)\\r\\n| sort by cost_diff desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Cost Diff DoD by Resource\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"InstanceName_s\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Subscription\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"MeterId_g\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":4,\"formatOptions\":{},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"p_cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"yellow\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"cost_diff\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"cost_pctdiff\",\"formatter\":0,\"formatOptions\":{},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}],\"rowLimit\":500},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"InstanceName_s\"],\"seriesLabelSettings\":[{\"seriesName\":\"Cost\",\"color\":\"blue\"},{\"seriesName\":\"p_cost\",\"color\":\"yellow\"},{\"seriesName\":\"cost_diff\",\"color\":\"redBright\"}],\"xSettings\":{},\"ySettings\":{}}},\"conditionalVisibility\":{\"parameterName\":\"ComparisionPeriod\",\"comparison\":\"isEqualTo\",\"value\":\"Day over Day\"},\"name\":\"DoD  - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| extend EoW=datetime_add('hour',-1*{timeoffset},endofweek(TimeGenerated))\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by InstanceId_s, InstanceName_s ,MeterId_g,Product_s, Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s, EoW\\r\\n| sort by Subscription ,InstanceName_s,MeterId_g,Product_s,  EoW asc\\r\\n| serialize\\r\\n|  extend  p_cost = iff(InstanceId_s==prev(InstanceId_s) and MeterId_g==prev(MeterId_g), p_cost = prev(Cost,1) , p_cost=Cost)\\r\\n| project  InstanceId_s, InstanceName_s, Subscription , SubscriptionName , EoW ,MeterId_g,Product_s, Cost , p_cost , cost_diff=Cost-p_cost, cost_pctdiff=(Cost/p_cost)*100-100\\r\\n| sort by cost_diff desc\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"Cost Diff WoW\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"InstanceName_s\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Subscription\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"MeterId_g\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":4,\"formatOptions\":{},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"p_cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"yellow\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"cost_diff\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"cost_pctdiff\",\"formatter\":0,\"formatOptions\":{},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}],\"rowLimit\":500},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"InstanceName_s\"],\"seriesLabelSettings\":[{\"seriesName\":\"Cost\",\"color\":\"blue\"},{\"seriesName\":\"p_cost\",\"color\":\"yellow\"},{\"seriesName\":\"cost_diff\",\"color\":\"redBright\"}],\"xSettings\":{},\"ySettings\":{}}},\"conditionalVisibility\":{\"parameterName\":\"ComparisionPeriod\",\"comparison\":\"isEqualTo\",\"value\":\"Week over Week\"},\"name\":\"WoW\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where iff( {TimeRange:start}<=ago(60d) , TimeGenerated >= startofmonth({TimeRange:start}),TimeGenerated >= startofmonth(datetime_add('month',-2, now())))\\r\\n| extend EoM=datetime_add('hour',-1*{timeoffset},endofmonth(TimeGenerated))\\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| summarize Cost=round(sum(PretaxCost_d),4) by InstanceId_s, InstanceName_s ,MeterId_g,Product_s, Subscription=SubscriptionGuid_g , SubscriptionName=SubscriptionName_s, EoM\\r\\n| sort by Subscription ,InstanceName_s,MeterId_g,Product_s,  EoM asc\\r\\n| serialize\\r\\n|  extend  p_cost = iff(InstanceId_s==prev(InstanceId_s) and MeterId_g==prev(MeterId_g), p_cost = prev(Cost,1) , p_cost=Cost)\\r\\n| project  InstanceId_s, InstanceName_s, Subscription , SubscriptionName , EoM ,MeterId_g,Product_s, Cost , p_cost , cost_diff=Cost-p_cost, cost_pctdiff=(Cost/p_cost)*100-100\\r\\n| sort by cost_diff desc\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"Cost Diff MoM\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"InstanceName_s\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Subscription\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"MeterId_g\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":4,\"formatOptions\":{},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"p_cost\",\"formatter\":4,\"formatOptions\":{\"palette\":\"yellow\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"cost_diff\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"cost_pctdiff\",\"formatter\":0,\"formatOptions\":{},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"SubscriptionGuid_g\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null}}],\"rowLimit\":500},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ConsumedService\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"Cost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"InstanceName_s\"],\"seriesLabelSettings\":[{\"seriesName\":\"Cost\",\"color\":\"blue\"},{\"seriesName\":\"p_cost\",\"color\":\"yellow\"},{\"seriesName\":\"cost_diff\",\"color\":\"redBright\"}],\"xSettings\":{},\"ySettings\":{}}},\"conditionalVisibility\":{\"parameterName\":\"ComparisionPeriod\",\"comparison\":\"isEqualTo\",\"value\":\"Month Over Month\"},\"name\":\"MoM\"},{\"type\":1,\"content\":{\"json\":\"## Compute - Virtual  Machines\"},\"name\":\"text - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated >= ago(2d)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| project PretaxCost_d, InstanceName_s, UsageType, VCPUs, ServiceType, ImageType, Product_s, ConsumptionMeter\\r\\n| where UsageType == \\\"ComputeHR\\\" \\r\\n| extend OS=iff(isempty(ImageType) or ImageType startswith \\\"Windows\\\", \\\"Windows\\\",\\\"Linux\\\") \\r\\n| summarize Count=dcount(InstanceName_s) by OS\",\"size\":0,\"title\":\"OS Distribution\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Linux\",\"color\":\"yellow\"},{\"seriesName\":\"Windows\",\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - 28\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet timerange=2d;\\r\\n    AzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s \\r\\n| project TimeGenerated , InstanceName_s , ServiceType  \\r\\n| summarize Count=dcount(InstanceName_s) by ServiceType,Category=\\\"Total\\\"\\r\\n| union(\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s \\r\\n| project TimeGenerated , InstanceName_s , ServiceType  , ReservationId, Product_s , PretaxCost_d , VCPUs  ,MeterId_g\\r\\n| where isnotempty(ReservationId)\\r\\n| summarize Count=dcount(InstanceName_s) by ServiceType,Category=\\\"ReservedInstance\\\")\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"RI Usage\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"Count\"],\"group\":\"Category\",\"createOtherGroup\":null,\"seriesLabelSettings\":[{\"seriesName\":\"Total\",\"color\":\"blue\"},{\"seriesName\":\"ReservedInstance\",\"color\":\"orange\"}]}},\"customWidth\":\"33\",\"name\":\"query - 28 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureUsage_CL\\r\\n| where TimeGenerated >= ago(2d)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n//| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| project PretaxCost_d, InstanceName_s, UsageType, VCPUs, ServiceType, ImageType, Product_s, ConsumptionMeter\\r\\n| where UsageType == \\\"ComputeHR\\\" \\r\\n| extend OS=iff(isempty(ImageType) or ImageType startswith \\\"Windows\\\", \\\"Windows\\\",\\\"Linux\\\") \\r\\n| where OS==\\\"Windows\\\"\\r\\n| extend Ahub=iff(ImageType==\\\"Windows Server BYOL\\\", \\\"Ahub\\\",\\\"PayG\\\") \\r\\n| summarize Count=dcount(InstanceName_s) by Ahub\\r\\n\",\"size\":0,\"title\":\"AHUB Usage\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Ahub\",\"color\":\"green\"},{\"seriesName\":\"PayG\",\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - 28 - Copy\"},{\"type\":1,\"content\":{\"json\":\"## VM Counts from Usage ( Last Day )\"},\"name\":\"text - 30\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let timerange=1d;\\r\\n    AzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s \\r\\n| project TimeGenerated , InstanceName_s , ServiceType  \\r\\n| summarize TotalVMs=dcount(InstanceName_s) by ServiceType\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SSH/RDP\",\"formatter\":4,\"formatOptions\":{}},{\"columnMatch\":\"bootcount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"InboundCon\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_p95\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_avg\",\"formatter\":8,\"formatOptions\":{\"palette\":\"hotCold\"}},{\"columnMatch\":\"Nw_Sent\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redGreen\"}},{\"columnMatch\":\"Nw_Rec\",\"formatter\":4,\"formatOptions\":{\"palette\":\"redGreen\"}}]},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ServiceType\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"TotalVMs\",\"formatter\":8,\"formatOptions\":{\"palette\":\"yellowGreen\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet timerange=1d;\\r\\n    AzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s \\r\\n| project TimeGenerated , InstanceName_s , ServiceType  \\r\\n| summarize TotalVMs=dcount(InstanceName_s) by ServiceType\\r\\n| join kind= fullouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s \\r\\n| project TimeGenerated , InstanceName_s , ServiceType  , ReservationId, Product_s , PretaxCost_d , VCPUs  ,MeterId_g\\r\\n| where isnotempty(ReservationId)\\r\\n| summarize VMwithReservation=dcount(InstanceName_s) by ServiceType\\r\\n) on ServiceType\\r\\n|project Family=ServiceType,TotalVMs,VMwithReservation=iff(isempty(VMwithReservation),0,VMwithReservation)\\r\\n\\r\\n\\r\\n\",\"size\":0,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SSH/RDP\",\"formatter\":4,\"formatOptions\":{}},{\"columnMatch\":\"bootcount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"InboundCon\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_p95\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_avg\",\"formatter\":8,\"formatOptions\":{\"palette\":\"hotCold\"}},{\"columnMatch\":\"Nw_Sent\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redGreen\"}},{\"columnMatch\":\"Nw_Rec\",\"formatter\":4,\"formatOptions\":{\"palette\":\"redGreen\"}}]},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ServiceType\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"VMCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"yellowGreen\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"Family\",\"yAxis\":[\"TotalVMs\",\"VMwithReservation\"],\"seriesLabelSettings\":[{\"seriesName\":\"TotalVMs\",\"color\":\"orange\"},{\"seriesName\":\"VMwithReservation\",\"color\":\"blue\"}],\"xSettings\":{},\"ySettings\":{}}},\"name\":\"query - 19 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let timerange=1d;\\r\\n    AzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s , Location=InstanceLocation_s\\r\\n| project TimeGenerated , InstanceName_s , ServiceType  ,Location\\r\\n| summarize TotalVMs=dcount(InstanceName_s) by ServiceType,Location\\r\\n| join kind= fullouter (\\r\\nAzureUsage_CL\\r\\n| where TimeGenerated >= ago(timerange)\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by  InstanceName_s , ServiceType , Product_s \\r\\n| project TimeGenerated , InstanceName_s , ServiceType  , ReservationId, Product_s , PretaxCost_d , VCPUs  ,MeterId_g\\r\\n| where isnotempty(ReservationId)\\r\\n| summarize VMwithReservation=dcount(InstanceName_s) by ServiceType\\r\\n) on ServiceType\\r\\n|project Family=ServiceType,TotalVMs,VMwithReservation=iff(isempty(VMwithReservation),0,VMwithReservation),Location\\r\\n| where VMwithReservation<TotalVMs\\r\\n\\r\\n\\r\\n\",\"size\":4,\"title\":\"VMs without Reservation\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SSH/RDP\",\"formatter\":4,\"formatOptions\":{}},{\"columnMatch\":\"bootcount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"InboundCon\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_p95\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_avg\",\"formatter\":8,\"formatOptions\":{\"palette\":\"hotCold\"}},{\"columnMatch\":\"Nw_Sent\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redGreen\"}},{\"columnMatch\":\"Nw_Rec\",\"formatter\":4,\"formatOptions\":{\"palette\":\"redGreen\"}}]},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Family\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"TotalVMs\",\"formatter\":8,\"formatOptions\":{\"palette\":\"yellowGreen\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Location\",\"formatOptions\":{}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"Family\",\"yAxis\":[\"TotalVMs\",\"VMwithReservation\"],\"seriesLabelSettings\":[{\"seriesName\":\"TotalVMs\",\"color\":\"orange\"},{\"seriesName\":\"VMwithReservation\",\"color\":\"blue\"}],\"xSettings\":{},\"ySettings\":{}}},\"name\":\"query - 19 - Copy - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 26\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"cellValue\":\"shownori\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Show No RI Only\",\"subTarget\":\"1\",\"preText\":\"\",\"style\":\"link\"},{\"cellValue\":\"shownori\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Show All\",\"subTarget\":\"0\",\"style\":\"link\"}]},\"name\":\"links - 28\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"    AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| summarize arg_max(PretaxCost_d, *) by  TimeGenerated, InstanceId_s,MeterId_g, Name_g,SubscriptionGuid_g,SubscriptionName_s,  InstanceLocation_s \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize Cost=round(sum(PretaxCost_d),4)  by ResourceId=InstanceId_s, InstanceName_s , ServiceType , Product_s , SubscriptionName_s\\r\\n| where Product_s <> \\\"VM RI - Compute\\\" \\r\\n| join kind= leftouter (\\r\\n        AzureUsage_CL\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where ConsumedService_s == \\\"Microsoft.Compute\\\" \\r\\n| where SubscriptionGuid_g in ({subscription}) or '*' in ({subscription})\\r\\n| extend ReservationId = tostring(parse_json(AdditionalInfo_s).ReservationId) \\r\\n| extend ReservationOrderId = tostring(parse_json(AdditionalInfo_s).ReservationOrderId)\\r\\n| extend UsageType = tostring(parse_json(AdditionalInfo_s).UsageType)  \\r\\n| extend VCPUs = tostring(parse_json(AdditionalInfo_s).VCPUs) \\r\\n| extend ServiceType= tostring(parse_json(AdditionalInfo_s).ServiceType) \\r\\n| extend ImageType = tostring(parse_json(AdditionalInfo_s).ImageType) \\r\\n| extend ConsumptionMeter = tostring(parse_json(AdditionalInfo_s).ConsumptionMeter) \\r\\n| where UsageType startswith \\\"ComputeHR\\\"\\r\\n| summarize Cost=round(sum(PretaxCost_d),4)  by ResourceId=InstanceId_s, InstanceName_s , ServiceType , Product_s , SubscriptionName_s\\r\\n| where Product_s == \\\"VM RI - Compute\\\" \\r\\n) on ResourceId\\r\\n|project ResourceId , InstanceName=InstanceName_s , ServiceType , Product=Product_s ,Cost, isRI=iff(Product_s1==\\\"VM RI - Compute\\\" , \\\"RI\\\" , \\\"No RI\\\"), SubscriptionName=SubscriptionName_s\\r\\n| where iff({shownori}==1,isRI==\\\"No RI\\\",1==1)\\r\\n\",\"size\":0,\"title\":\"VM Cost for Selected Time \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ResourceId\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"InstanceName\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"Cost\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"InstanceName_s\",\"formatter\":5,\"formatOptions\":{}},{\"columnMatch\":\"SSH/RDP\",\"formatter\":4,\"formatOptions\":{}},{\"columnMatch\":\"bootcount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"InboundCon\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_p95\",\"formatter\":8,\"formatOptions\":{}},{\"columnMatch\":\"cpu_avg\",\"formatter\":8,\"formatOptions\":{\"palette\":\"hotCold\"}},{\"columnMatch\":\"Nw_Sent\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redGreen\"}},{\"columnMatch\":\"Nw_Rec\",\"formatter\":4,\"formatOptions\":{\"palette\":\"redGreen\"}}],\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceId_0\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceId_0\",\"sortOrder\":1}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ServiceType\",\"formatter\":1,\"formatOptions\":{}},\"leftContent\":{\"columnMatch\":\"VMCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"yellowGreen\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false},\"chartSettings\":{\"xAxis\":\"Family\",\"yAxis\":[\"TotalVMs\",\"VMwithReservation\"],\"seriesLabelSettings\":[{\"seriesName\":\"TotalVMs\",\"color\":\"orange\"},{\"seriesName\":\"VMwithReservation\",\"color\":\"blue\"}],\"xSettings\":{},\"ySettings\":{}}},\"name\":\"query - 19 - Copy - Copy - Copy\"}],\"isLocked\":false,\"defaultResourceIds\":[\"/subscriptions/2de20a16-20c6-41af-82cd-bceb39195d1c/resourceGroups/rg-shared-sc-weu/providers/Microsoft.OperationalInsights/workspaces/la-prod-sc-weu\",\"Azure Monitor\"],\"fallbackResourceIds\":[\"/subscriptions/2de20a16-20c6-41af-82cd-bceb39195d1c/resourceGroups/rg-shared-sc-weu/providers/Microsoft.OperationalInsights/workspaces/la-prod-sc-weu\",\"Azure Monitor\"]}",
         "version": "1.0",
        "sourceId": "[variables('workbookSourceId')]",
        "category": "[variables('workbookType')]"
      }
    }
    ],
    "outputs": {}
}